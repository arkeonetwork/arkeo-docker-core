<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arkeo Marketplace | Sentinel Management</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.ico">
    <link rel="shortcut icon" href="images/favicon.ico">
</head>
<body>

<div id="savingOverlay" class="overlay hidden">
    <div class="overlay-card">
        <h3>Please wait…</h3>
        <p>Updating sentinel config and restarting the sentinel. This can take up to ~15 seconds.</p>
    </div>
</div>

<div class="card header-card">
    <div class="row-between header-top">
        <div class="header-left">
            <div class="header-brand-row">
                <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="header-logo">
                <div class="header-brand">
                    <span class="brand-main">Arkeo Marketplace</span>
                    <span class="brand-sep">|</span>
                    <span class="brand-sub">Provider Manager</span>
                </div>
            </div>
            <h1>Sentinel Management</h1>
        </div>
        <div class="header-right">
            <a class="btn primary" href="index.html">Back to Admin Home</a>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between">
        <div class="inline">
            <h2 class="mt-0">Sentinel Settings</h2>
            <span id="refreshPill" class="status-badge status-warn hidden">Refreshing…</span>
        </div>
    </div>
    <table>
        <tr>
            <td class="label">
                Provider Name
                <div class="hint">Moniker/label for this sentinel.</div>
            </td>
            <td class="value">
                <input type="text" id="providerName" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Moniker
                <div class="hint">Display moniker for this provider.</div>
            </td>
            <td class="value">
                <input type="text" id="moniker" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Website
                <div class="hint">Public website URL.</div>
            </td>
            <td class="value">
                <input type="text" id="website" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Description
                <div class="hint">Provider description.</div>
            </td>
            <td class="value">
                <input type="text" id="description" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Location
                <div class="hint">Provider location text.</div>
            </td>
            <td class="value">
                <input type="text" id="location" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Free Rate Limit
                <div class="hint">Number of free requests allowed per duration.</div>
            </td>
            <td class="value">
                <input type="text" id="freeRateLimit" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Free Rate Limit Duration
                <div class="hint">Duration window for the free rate limit (e.g. 1m).</div>
            </td>
            <td class="value">
                <input type="text" id="freeRateLimitDuration" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Provider Pubkey
                <div class="hint">Bech32 provider pubkey used on-chain.</div>
            </td>
            <td class="value">
                <span id="providerPubkey">(loading...)</span>
            </td>
        </tr>
        <tr>
            <td class="label">
                Listen Address
                <div class="hint">Sentinel API listen address (read-only).</div>
            </td>
            <td class="value"><span id="listenAddr">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Sentinel URI
                <div class="hint">Endpoint exposed by the sentinel (metadata.json).</div>
            </td>
            <td class="value"><span id="sentinelUri">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Arkeod Node
                <div class="hint">RPC endpoint sentinel watches for events.</div>
            </td>
            <td class="value"><span id="arkeodNode">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Hotwallet Key
                <div class="hint">Configured provider key name.</div>
            </td>
            <td class="value"><span id="walletKey">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Hotwallet Pubkey
                <div class="hint">Bech32 pubkey used on-chain.</div>
            </td>
            <td class="value"><span id="bech32Pubkey">(loading...)</span></td>
        </tr>
        <tr>
            <td colspan="2" class="text-left pt-12 no-border">
                <button class="primary" id="saveSentinelBtn" onclick="saveConfig()">Save Sentinel Config</button>
            </td>
        </tr>
    </table>
    <pre id="saveResult" class="hidden"></pre>
</div>

<div class="card footer-card">
    <div class="footer-links">
        <div class="footer-brand">
            <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="footer-logo">
            <span class="footer-title">
                <span class="brand-main">Arkeo Marketplace</span>
                <span class="brand-sep">|</span>
                <span class="brand-sub">Provider Manager</span>
            </span>
        </div>
        <div class="footer-links-right">
            <div><a href="https://arkeo.network/" target="_blank" rel="noopener">Arkeo Marketplace Website</a></div>
            <div><a href="https://discord.gg/arkeo" target="_blank" rel="noopener">Arkeo Discord</a></div>
        </div>
    </div>
</div>

<div class="card">

    <h3>Debug Info</h3>

    <button class="primary" onclick="loadInfo()">Refresh</button>
    <button class="primary" onclick="exportSentinelBundle()">Export Sentinel Config</button>
    <pre id="sentinelMeta">(loading...)</pre>
    <pre id="exportResult" class="pre-wrap"></pre>

    <div class="panel mt-14">
        <h3>Sentinel YAML</h3>
        <div class="hint">provider + services from sentinel.yaml</div>
        <pre id="sentinelYaml">(loading...)</pre>
    </div>

    <div class="panel mt-14">
        <h3>Sentinel Metadata</h3>
        <div class="hint">metadata.json from the sentinel endpoint</div>
        <pre id="debugInfo">Loading...</pre>
    </div>

</div>

<script>
    const DEFAULT_ADMIN_API_PORT = "9999";
    let adminHost = (window.location && window.location.hostname) || "localhost";
    let adminApiBase = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT);

    function buildBaseUrl(host, port) {
        const proto = (window.location && window.location.protocol === "https:") ? "https:" : "http:";
        const cleaned = (host || "").replace(/^https?:\/\//, "").replace(/\/+$/, "");
        return `${proto}//${cleaned}${port ? `:${port}` : ""}`;
    }

    function extractHostFromValue(val) {
        if (!val) return "";
        try {
            const u = val.startsWith("http") ? new URL(val) : new URL(`http://${val}`);
            return u.hostname || "";
        } catch (e) {
            return "";
        }
    }

    function setAdminHost(candidateHost) {
        // Keep adminApiBase anchored to the page host; do not override.
        return;
    }

    function resolveApi(path) {
        if (!path.startsWith("/")) path = `/${path}`;
        return `${adminApiBase}${path}`;
    }

    async function loadInfo() {
        const debug = document.getElementById("debugInfo");
        const pill = document.getElementById("refreshPill");
        if (pill) pill.style.display = "inline-block";
        debug.textContent = "Loading...";
        try {
            // Use loopback for metadata fetch in the form to avoid external loopback issues
            const [provRes, cfgRes, metaRes] = await Promise.all([
                fetch(resolveApi("/api/provider-info")),
                fetch(resolveApi("/api/sentinel-config")),
                fetch(resolveApi("/api/sentinel-metadata?loopback=1")),
            ]);
            const prov = await provRes.json();
            const cfg = await cfgRes.json();
            const meta = await metaRes.json();
            const metaCfg = (meta && meta.metadata && meta.metadata.config) || (meta && meta.config) || {};

            if (provRes.ok) {
                document.getElementById("sentinelUri").textContent = prov.sentinel_uri || cfg.sentinel_uri_default || "(not set)";
                document.getElementById("arkeodNode").textContent = prov.arkeod_node || "(not set)";
                document.getElementById("walletKey").textContent = prov.user || "(not set)";
                document.getElementById("bech32Pubkey").textContent =
                    (prov.pubkey && prov.pubkey.bech32) || prov.pubkey_error || "(not set)";
                if (prov.sentinel_uri) setAdminHost(prov.sentinel_uri);
            }

            const yamlEl = document.getElementById("sentinelYaml");
            if (cfg.raw) {
                yamlEl.textContent = cfg.raw;
            } else {
                yamlEl.textContent = "(no sentinel.yaml found)";
            }

            // Inputs
            const providerCfg = (cfg.config && cfg.config.provider) || {};
            const apiCfg = (cfg.config && cfg.config.api) || {};
            const envFile = cfg.env_file || {};
            const pick = (...vals) => vals.find(v => v !== undefined && v !== null && `${v}`.trim() !== "");
            const metaFreeRate = pick(metaCfg.free_tier_rate_limit, metaCfg.free_rate_limit, metaCfg.freeRateLimit);
            const metaFreeDur = pick(metaCfg.free_tier_rate_limit_duration, metaCfg.free_rate_limit_duration, metaCfg.freeRateLimitDuration);
            document.getElementById("providerName").value = pick(metaCfg.provider_name, providerCfg.name, envFile.PROVIDER_NAME, "");
            document.getElementById("providerPubkey").textContent = pick(metaCfg.provider_pubkey, providerCfg.pubkey, prov.pubkey && prov.pubkey.bech32, "(not set)");
            document.getElementById("listenAddr").textContent = pick(metaCfg.port && `0.0.0.0:${metaCfg.port}`, apiCfg.listen_addr, "0.0.0.0:3636");
            document.getElementById("moniker").value = pick(metaCfg.moniker, envFile.MONIKER, "");
            document.getElementById("website").value = pick(metaCfg.website, envFile.WEBSITE, "");
            document.getElementById("description").value = pick(metaCfg.description, envFile.DESCRIPTION, "");
            document.getElementById("location").value = pick(metaCfg.location, envFile.LOCATION, "");
            document.getElementById("freeRateLimit").value = pick(metaFreeRate, envFile.FREE_RATE_LIMIT, "");
            document.getElementById("freeRateLimitDuration").value = pick(metaFreeDur, envFile.FREE_RATE_LIMIT_DURATION, "");

            // metadata view
            document.getElementById("sentinelMeta").textContent = JSON.stringify(meta, null, 2);
            debug.textContent = JSON.stringify({ provider_info: prov, sentinel_config: cfg, sentinel_metadata: meta }, null, 2);
        } catch (e) {
            debug.textContent = "Failed to load info: " + e;
        } finally {
            if (pill) pill.style.display = "none";
        }
    }

    function showSavingOverlay(show) {
        const el = document.getElementById("savingOverlay");
        if (!el) return;
        el.style.display = show ? "flex" : "none";
    }

    async function exportSentinelBundle() {
        const resEl = document.getElementById("exportResult");
        if (resEl) {
            resEl.style.display = "block";
            resEl.textContent = "Exporting sentinel config...";
        }
        try {
            const res = await fetch(resolveApi("/api/provider-export"), { method: "POST" });
            const data = await res.json();
            if (res.ok) {
                const pretty = JSON.stringify(data.export, null, 2);
                resEl.textContent = `Exported to ${data.path || "(unknown)"}${data.bytes ? ` (${data.bytes} bytes)` : ""}\n\n${pretty}`;
            } else {
                resEl.textContent = `Export failed: ${JSON.stringify(data, null, 2)}`;
            }
        } catch (e) {
            if (resEl) resEl.textContent = "Export request failed: " + e;
        }
    }

    async function saveConfig() {
        const btn = document.getElementById("saveSentinelBtn");
        if (btn) { btn.disabled = true; btn.textContent = "Saving..."; }
        showSavingOverlay(true);
        const payload = {
            provider_name: document.getElementById("providerName").value.trim(),
            moniker: document.getElementById("moniker").value.trim(),
            website: document.getElementById("website").value.trim(),
            description: document.getElementById("description").value.trim(),
            location: document.getElementById("location").value.trim(),
            free_rate_limit: document.getElementById("freeRateLimit").value.trim(),
            free_rate_limit_duration: document.getElementById("freeRateLimitDuration").value.trim(),
        };
        const resEl = document.getElementById("saveResult");
        resEl.style.display = "block";
        resEl.textContent = "Saving...";
        try {
            const res = await fetch(resolveApi("/api/sentinel-config"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            resEl.textContent = res.ok ? "Saved:\n" + JSON.stringify(data, null, 2) : "Error:\n" + JSON.stringify(data, null, 2);
            if (res.ok) {
                window.location.href = "index.html";
            }
        } catch (e) {
            resEl.textContent = "Request failed: " + e;
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = "Save Sentinel Config"; }
            // Hide overlay only if we stay on the page (errors)
            showSavingOverlay(false);
        }
    }

    window.addEventListener("load", loadInfo);
</script>

</body>
</html>
