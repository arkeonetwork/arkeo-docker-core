<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arkeo Data Marketplace | Subscriber Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.ico">
    <link rel="shortcut icon" href="images/favicon.ico">
</head>
<body>

<div class="card header-card">
    <div class="row-between header-top">
        <div class="header-left">
            <div class="header-brand-row">
                <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="header-logo">
                <div class="header-brand">
                    <span class="brand-main">Arkeo Data Marketplace</span>
                    <span class="brand-sep">|</span>
                    <span class="brand-sub">Subscriber Manager</span>
                </div>
            </div>
            <h1>Admin Area</h1>
            <div class="muted">Quick links, health checks, and subscriber settings.</div>
        </div>
        <div class="header-right header-right-with-actions">
            <div class="header-actions">
                <a class="btn-ghost" href="index.html">Back to Dashboard</a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between align-center">
        <div class="inline">
            <h2 class="mt-0 mb-0">Admin Overview</h2>
        </div>
    </div>
    <div class="grid-two">
        <div class="panel stack">
            <div>
                <strong>Admin API</strong>
                <div id="adminApiVersion" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Admin API URL</strong>
                <div id="adminApiUrl" class="muted mt-6"></div>
            </div>
            <div>
                <strong>Admin UI URL</strong>
                <div id="adminUiUrl" class="muted mt-6"></div>
            </div>
        </div>
        <div class="panel stack">
            <div>
                <strong>Block Height</strong>
                <div id="blockHeightDisplay" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Subscriber Balance</strong>
                <div id="balanceDisplay" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Subscriber Pubkey</strong>
                <div id="overviewPubkeyDisplay" class="muted mt-6">(loading...)</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between align-center">
        <div class="inline">
            <h2 class="mt-0 mb-0">Subscriber Settings</h2>
            <div class="hint">Values formerly stored in subscriber.env. Update and save here.</div>
        </div>
        <div class="actions">
            <button class="primary" type="submit" form="subscriberSettingsForm">Save Settings</button>
        </div>
    </div>
    <form id="subscriberSettingsForm" onsubmit="saveSubscriberSettings(event)">
    <table>
        <tr>
            <td class="label">Subscriber Name</td>
            <td class="value"><input type="text" id="subscriberName" placeholder="Arkeo Core Subscriber" autocomplete="on" /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Key Name</td>
            <td class="value"><input type="text" id="keyName" readonly /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Keyring Backend <span class="muted" id="keyBackendLabel">(default)</span></td>
            <td class="value"><div id="keyBackendValue" class="muted">(read-only)</div></td>
        </tr>
        <tr>
            <td class="label">Chain ID</td>
            <td class="value"><input type="text" id="chainId" placeholder="arkeo-main-v1" /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Arkeod Home <span class="muted" id="arkeodHomeLabel"></span></td>
            <td class="value"><div id="arkeodHomeValue" class="muted">(read-only)</div></td>
        </tr>
        <tr>
            <td class="label">Arkeod Node (RPC)</td>
            <td class="value"><input type="text" id="arkeodNode" placeholder="tcp://127.0.0.1:26657" /></td>
        </tr>
        <tr>
            <td class="label">Arkeo REST API</td>
            <td class="value"><input type="text" id="arkeodRest" placeholder="http://127.0.0.1:1317" /></td>
        </tr>
        <tr>
            <td class="label">Admin UI Port</td>
            <td class="value"><input type="text" id="adminPort" placeholder="8079" autocomplete="on" /></td>
        </tr>
        <tr>
            <td class="label">Admin API Port</td>
            <td class="value"><input type="text" id="adminApiPort" placeholder="9998" autocomplete="on" /></td>
        </tr>
        <tr>
            <td class="label">
                Cache Fetch Interval (seconds)
                <div class="hint">Background sync cadence. Set to 0 to disable background sync.</div>
            </td>
            <td class="value"><input type="number" id="cacheFetchInterval" placeholder="150" min="0" step="1" /></td>
        </tr>
        <tr>
            <td class="label">
                Allow Localhost Sentinel URIs
                <div class="hint">Permit active providers whose metadata points at localhost/127.* sentinel URIs.</div>
            </td>
            <td class="value">
                <label class="inline">
                    <input type="checkbox" id="allowLocalhostSentinel" />
                    <span>Allow localhost sentinel URIs</span>
                </label>
            </td>
        </tr>
        <tr>
            <td class="label">
                Hotwallet Mnemonic
                <div class="hint">Current mnemonic is auto-saved (settings + ~/.arkeo/*_mnemonic.txt). Paste a new one to delete and recreate the hotwallet.</div>
            </td>
            <td class="value"><textarea id="hotwalletMnemonic" rows="3"></textarea></td>
        </tr>
        <tr class="hidden">
            <td class="label">Derived Pubkey</td>
            <td class="value"><div id="subscriberPubkeyDisplay" class="muted">(loading...)</div></td>
        </tr>
    </table>
    <div id="subscriberSettingsResult" class="muted" aria-live="polite"></div>
    </form>
</div>

<div class="card footer-card">
    <div class="footer-links">
        <div class="footer-brand">
            <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="footer-logo">
            <span class="footer-title">
                <span class="brand-main">Arkeo Marketplace</span>
                <span class="brand-sep">|</span>
                <span class="brand-sub">Subscriber Manager</span>
            </span>
        </div>
        <div class="footer-links-right">
            <div><a href="https://arkeo.network/" target="_blank" rel="noopener">Arkeo Marketplace Website</a></div>
            <div><a href="https://discord.gg/arkeo" target="_blank" rel="noopener">Arkeo Discord</a></div>
        </div>
    </div>
</div>

<script>
    const DEFAULT_ADMIN_API_PORT = "9998";
    const DEFAULT_ADMIN_UI_PORT = "8079";
    let adminHost = (window.location && window.location.hostname) || "localhost";
    let adminApiBase = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT);
    let subscriberSettingsCache = {};

    function buildBaseUrl(host, port) {
        const proto = (window.location && window.location.protocol === "https:") ? "https:" : "http:";
        const cleaned = (host || "").replace(/^https?:\/\//, "").replace(/\/+$/, "");
        return `${proto}//${cleaned}${port ? `:${port}` : ""}`;
    }

    function resolveApi(path) {
        if (!path.startsWith("/")) path = `/${path}`;
        return `${adminApiBase}${path}`;
    }

    function formatBalance(balanceObj) {
        const coins =
            (balanceObj && balanceObj.balance && balanceObj.balance.result && Array.isArray(balanceObj.balance.result) && balanceObj.balance.result) ||
            (balanceObj && balanceObj.balance && balanceObj.balance.balances && Array.isArray(balanceObj.balance.balances) && balanceObj.balance.balances) ||
            [];
        if (!coins.length) return "0 uarkeo";
        const fmtCoin = (c) => {
            const amount = c.amount || c.Amount || "";
            const denom = c.denom || c.Denom || "";
            if (denom === "uarkeo") {
                const num = parseInt(amount || "0", 10);
                const val = num / 1e8;
                return `${val.toLocaleString("en-US", { minimumFractionDigits: 8, maximumFractionDigits: 8 })} ARKEO`;
            }
            return `${amount}${denom}`;
        };
        return coins.map(fmtCoin).join(", ");
    }

    function formatBlockHeight(heightObj) {
        const h =
            (heightObj && heightObj.height) ||
            (heightObj && heightObj.status && (heightObj.status.latest_block_height || (heightObj.status.SyncInfo && heightObj.status.SyncInfo.latest_block_height)));
        if (!h) return "(unknown)";
        const num = Number(h);
        if (!Number.isFinite(num)) return String(h);
        return num.toLocaleString("en-US");
    }

    function formatPubkeyShort(pk) {
        if (!pk) return "";
        const str = String(pk);
        if (str.length <= 17) return str;
        return `${str.slice(0, 9)}...${str.slice(-8)}`;
    }

    function setBadge() {
        // badge removed
        return;
    }

    async function loadAdminInfo() {
        setBadge("warn", "Refreshingâ€¦");
        const fetchNoStore = (url) => fetch(url, { cache: "no-store" });
        const parseSafe = async (settled) => {
            if (settled.status !== "fulfilled" || !settled.value) return { error: String(settled.reason || "request failed") };
            try {
                if (!settled.value.ok) {
                    const text = await settled.value.text().catch(() => "");
                    return { error: `${settled.value.status} ${settled.value.statusText || ""}`, body: text };
                }
                return await settled.value.json();
            } catch (err) {
                return { error: "invalid json", detail: String(err) };
            }
        };
        try {
            const [verRes, heightRes, balRes, infoRes] = await Promise.allSettled([
                fetchNoStore(resolveApi("/api/version")),
                fetchNoStore(resolveApi("/api/block-height")),
                fetchNoStore(resolveApi("/api/balance")),
                fetchNoStore(resolveApi("/api/subscriber-info")),
            ]);
            const version = await parseSafe(verRes);
            const height = await parseSafe(heightRes);
            const balance = await parseSafe(balRes);
            const info = await parseSafe(infoRes);

            const apiVersionEl = document.getElementById("adminApiVersion");
            if (apiVersionEl) apiVersionEl.textContent = version && !version.error ? version.arkeod_version || "(unknown)" : "Unavailable";

            const apiUrlEl = document.getElementById("adminApiUrl");
            if (apiUrlEl) apiUrlEl.textContent = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT) + "/api/version";

            const uiUrlEl = document.getElementById("adminUiUrl");
            if (uiUrlEl) uiUrlEl.textContent = buildBaseUrl(adminHost, DEFAULT_ADMIN_UI_PORT);

            const heightEl = document.getElementById("blockHeightDisplay");
            if (heightEl) heightEl.textContent = formatBlockHeight(height);

            const balEl = document.getElementById("balanceDisplay");
            if (balEl) balEl.textContent = formatBalance(balance);

            const pubEl = document.getElementById("overviewPubkeyDisplay");
            const bech32 = (info && info.pubkey && info.pubkey.bech32) || "";
            if (pubEl) {
                if (bech32) {
                    pubEl.textContent = formatPubkeyShort(bech32);
                } else if (!pubEl.textContent || pubEl.textContent === "(unavailable)") {
                    pubEl.textContent = "(unavailable)";
                }
            }

            const hasErrors = !!(version && version.error) || !!(height && height.error) || !!(balance && balance.error);
            setBadge(hasErrors ? "warn" : "ok", hasErrors ? "Partial data" : "Up to date");
        } catch (e) {
            setBadge("err", "Failed to refresh");
        }
    }

    function setSubscriberInput(id, val) {
        const el = document.getElementById(id);
        if (el) el.value = val || "";
    }

    const DEFAULTS = {
        SUBSCRIBER_NAME: "Arkeo Core Subscriber",
        KEY_NAME: "subscriber",
        KEY_KEYRING_BACKEND: "test",
        CHAIN_ID: "arkeo-main-v1",
        ARKEOD_HOME: "/root/.arkeo",
        ARKEOD_NODE: "tcp://127.0.0.1:26657",
        ARKEO_REST_API: "http://127.0.0.1:1317",
        ADMIN_PORT: "8079",
        ADMIN_API_PORT: "9998",
        CACHE_FETCH_INTERVAL: "150",
    };

    function setInputWithDefault(id, val, fallbackKey) {
        const el = document.getElementById(id);
        if (!el) return;
        const finalVal = val || DEFAULTS[fallbackKey] || "";
        el.value = finalVal;
    }

    function setStatusMessage(text, isError = false) {
        const resultEl = document.getElementById("subscriberSettingsResult");
        if (!resultEl) return;
        resultEl.textContent = text || "";
        resultEl.classList.toggle("status-error", isError);
        resultEl.classList.toggle("status-success", !isError && !!text);
        resultEl.classList.toggle("error", isError);
    }

    async function loadSubscriberSettings(showStatus = true) {
        const resultEl = document.getElementById("subscriberSettingsResult");
        if (showStatus && resultEl) {
            setStatusMessage("Loading subscriber settings...", false);
        }
        try {
            const res = await fetch(resolveApi("/api/subscriber-settings"), { cache: "no-store" });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data && data.error ? data.error : res.statusText);
            }
            subscriberSettingsCache = data.settings || {};
            setInputWithDefault("subscriberName", subscriberSettingsCache.SUBSCRIBER_NAME, "SUBSCRIBER_NAME");
            setInputWithDefault("keyName", subscriberSettingsCache.KEY_NAME, "KEY_NAME");
            const backendLabel = document.getElementById("keyBackendLabel");
            const backendVal = document.getElementById("keyBackendValue");
            const backendText = subscriberSettingsCache.KEY_KEYRING_BACKEND || DEFAULTS.KEY_KEYRING_BACKEND;
            if (backendLabel) backendLabel.textContent = backendText;
            if (backendVal) backendVal.textContent = backendText;
            setInputWithDefault("chainId", subscriberSettingsCache.CHAIN_ID, "CHAIN_ID");
            const homeLabel = document.getElementById("arkeodHomeLabel");
            const homeVal = document.getElementById("arkeodHomeValue");
            const homeText = subscriberSettingsCache.ARKEOD_HOME || DEFAULTS.ARKEOD_HOME;
            if (homeLabel) homeLabel.textContent = homeText ? `(${homeText})` : "";
            if (homeVal) homeVal.textContent = homeText || "(read-only)";
            setInputWithDefault("arkeodNode", subscriberSettingsCache.ARKEOD_NODE, "ARKEOD_NODE");
            const restApiVal = subscriberSettingsCache.ARKEO_REST_API || subscriberSettingsCache.EXTERNAL_ARKEO_REST_API;
            setInputWithDefault("arkeodRest", restApiVal, "ARKEO_REST_API");
            setInputWithDefault("adminPort", subscriberSettingsCache.ADMIN_PORT, "ADMIN_PORT");
            setInputWithDefault("adminApiPort", subscriberSettingsCache.ADMIN_API_PORT, "ADMIN_API_PORT");
            setInputWithDefault("cacheFetchInterval", subscriberSettingsCache.CACHE_FETCH_INTERVAL, "CACHE_FETCH_INTERVAL");
            const allowLocalhost = subscriberSettingsCache.ALLOW_LOCALHOST_SENTINEL_URIS;
            const allowLocalhostEl = document.getElementById("allowLocalhostSentinel");
            if (allowLocalhostEl) {
                const val = String(allowLocalhost || "").toLowerCase();
                allowLocalhostEl.checked = val === "1" || val === "true" || val === "yes" || val === "on";
            }
            setSubscriberInput("hotwalletMnemonic", subscriberSettingsCache.KEY_MNEMONIC);
            const pubEl = document.getElementById("subscriberPubkeyDisplay");
            const pubkey = data.pubkey && data.pubkey.bech32 ? data.pubkey.bech32 : "";
            if (pubEl) pubEl.textContent = pubkey ? pubkey : "(unavailable)";
            const overviewEl = document.getElementById("overviewPubkeyDisplay");
            if (overviewEl) overviewEl.textContent = pubkey ? formatPubkeyShort(pubkey) : "(unavailable)";
            if (resultEl) {
                const src = data.mnemonic_source ? `Mnemonic source: ${data.mnemonic_source}.` : "";
                resultEl.textContent = `Loaded subscriber settings${data.subscriber_settings_path ? ` from ${data.subscriber_settings_path}` : ""}. ${src}`;
            }
        } catch (e) {
            if (resultEl) resultEl.textContent = `Failed to load subscriber settings: ${e}`;
        }
    }

    async function saveSubscriberSettings(event) {
        if (event && event.preventDefault) event.preventDefault();
        const normalizeRpc = (val) => {
            if (!val) return "";
            const trimmed = String(val).trim();
            const lower = trimmed.toLowerCase();
            if (lower.startsWith("tcp://")) return trimmed;
            if (lower.startsWith("http://")) return "tcp://" + trimmed.slice("http://".length);
            if (lower.startsWith("https://")) return "tcp://" + trimmed.slice("https://".length);
            return trimmed;
        };
        const payload = {
            settings: {
                SUBSCRIBER_NAME: document.getElementById("subscriberName")?.value || DEFAULTS.SUBSCRIBER_NAME,
                KEY_NAME: document.getElementById("keyName")?.value || DEFAULTS.KEY_NAME,
                KEY_KEYRING_BACKEND: subscriberSettingsCache.KEY_KEYRING_BACKEND || DEFAULTS.KEY_KEYRING_BACKEND,
                CHAIN_ID: document.getElementById("chainId")?.value || DEFAULTS.CHAIN_ID,
                ARKEOD_HOME: subscriberSettingsCache.ARKEOD_HOME || DEFAULTS.ARKEOD_HOME,
                ARKEOD_NODE: normalizeRpc(document.getElementById("arkeodNode")?.value || DEFAULTS.ARKEOD_NODE),
                ARKEO_REST_API: document.getElementById("arkeodRest")?.value || DEFAULTS.ARKEO_REST_API,
                ADMIN_PORT: document.getElementById("adminPort")?.value || DEFAULTS.ADMIN_PORT,
                ADMIN_API_PORT: document.getElementById("adminApiPort")?.value || DEFAULTS.ADMIN_API_PORT,
                CACHE_FETCH_INTERVAL: document.getElementById("cacheFetchInterval")?.value || DEFAULTS.CACHE_FETCH_INTERVAL,
                ALLOW_LOCALHOST_SENTINEL_URIS: document.getElementById("allowLocalhostSentinel")?.checked ? "1" : "0",
                KEY_MNEMONIC: document.getElementById("hotwalletMnemonic")?.value || "",
            },
        };
        const resultEl = document.getElementById("subscriberSettingsResult");
        let finalMessage = "Saving settings...";
        let isError = false;
        setStatusMessage(finalMessage, false);
        try {
            const res = await fetch(resolveApi("/api/subscriber-settings"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data && data.error ? data.error : res.statusText);
            }
            subscriberSettingsCache = data.settings || subscriberSettingsCache;
            if (data.pubkey && data.pubkey.bech32) {
                const pubEl = document.getElementById("subscriberPubkeyDisplay");
                if (pubEl) pubEl.textContent = data.pubkey.bech32;
                const overviewEl = document.getElementById("overviewPubkeyDisplay");
                if (overviewEl) overviewEl.textContent = formatPubkeyShort(data.pubkey.bech32);
            } else {
                const pubEl = document.getElementById("subscriberPubkeyDisplay");
                if (pubEl && (!pubEl.textContent || pubEl.textContent === "(unavailable)")) {
                    pubEl.textContent = "(unavailable)";
                }
                const overviewEl = document.getElementById("overviewPubkeyDisplay");
                if (overviewEl && (!overviewEl.textContent || overviewEl.textContent === "(unavailable)")) {
                    overviewEl.textContent = "(unavailable)";
                }
            }
            if (resultEl) {
                const rotated = data.mnemonic_rotated ? "Hotwallet re-imported with new mnemonic. " : "";
                finalMessage = `${rotated}Saved subscriber settings${data.subscriber_settings_path ? ` to ${data.subscriber_settings_path}` : ""}.`;
            }
            await loadAdminInfo();
            await loadSubscriberSettings(false);
            // Redirect to dashboard after successful save
            window.location.href = "index.html";
        } catch (e) {
            finalMessage = `Failed to save subscriber settings: ${e}`;
            isError = true;
        } finally {
            setStatusMessage(finalMessage, isError);
        }
    }

    window.addEventListener("load", () => {
        loadAdminInfo();
        loadSubscriberSettings();
        setInterval(loadAdminInfo, 5000);
        maybeShowSettingsRequiredModal();
    });

    function maybeShowSettingsRequiredModal() {
        const params = new URLSearchParams(window.location.search);
        const needs = params.get("needsSettings") === "1" || (window.location.hash || "").toLowerCase().includes("needssettings");
        if (needs) {
            const modal = document.getElementById("settingsRequiredModal");
            if (modal) modal.classList.remove("hidden");
        }
    }

    function dismissSettingsRequired() {
        const modal = document.getElementById("settingsRequiredModal");
        if (modal) modal.classList.add("hidden");
    }
</script>

<div id="settingsRequiredModal" class="overlay hidden">
    <div class="overlay-card">
        <h3>Setup Required</h3>
        <p class="muted">Please configure subscriber settings before using the app.</p>
        <div class="actions center mt-6">
            <button class="primary" onclick="dismissSettingsRequired()">Got it</button>
        </div>
    </div>
</div>

</body>
</html>
